##  持续集成与代码部署概述

FIT2CLOUD 提供一整套高效，稳定可落地的持续集成与部署方案，包括从代码更新到上线服务的整个流程，工作流程如下图：![](/assets/fit2.png)

在「DevOps平台」中点击上方导航栏中「代码部署」标签，展开相应功能列表。

## 「Jenkins」 代码部署插件与配置

Jenkins 作为持续集成服务，衔接代码版本控制服务和FIT2CLOUD，即承担编译打包、单元测试等功能，通过我们编写的 FIT2CLOUD 代码部署和阿里云 OSS 上传插件，Jenkins 还具备了注册应用版本、自动打包上传制品的功能。

### 「Jenkins」安装与配置

针对 Jenkins，我们提供了 Jenkins 从安装到配置插件的整套流程，如下所示（详细步骤可以查看 FIT2CLOUD 管理员使用文档）：

* 下载 Jenkins - FIT2CLOUD 离线安装包到一台事先准备好的机器（CentOS6.5 x64）

* 解压缩离线包，执行包中的 install.sh 安装 Jenkins， 正常情况下，我们就得了一个满足 FIT2CLOUD 代码部署环境的 Jenkins 实例（我们已经把最新版本的 FIT2CLOUD 插件事先部署在了离线包）。

* 通过 [http://IP](http://ip) 打开 Jenkins，默认登录用户名／密码（admin/fit2cloud)

### 「Jenkins」Job 配置 

在 Jenkins 页面中点击 new Job 新建一个项目，按照具体要实施代码部署任务的项目类型配置 Job

*  配置项目 SCM 地址 （一般根据 Git，SVN 等存在差异）
*  配置项目打包编译步骤（根据不同项目 Maven，Gradle 等存在差异）
*  配置 FIT2CLOUD 代码部署，在 After Build Step 中添加 「FIT2CLOUD 代码部署」，根据问号中的提示填写相应的信息，对于应用和仓库名称等信息，需要预先在FIT2CLOUD 中创建好。

## 「代码部署功能」仓库管理 

在进行代码部署之前，需要先将仓库的信息注册到 FIT2CLOUD 中，只有将仓库（Nexus／OSS）的信息注册到 FIT2CLOUD ，FIT2CLOUD 才能正确的通知 Agent 从相应的仓库下载应用制品。具体步骤如下：

*  点击进入代码部署->仓库管理界面

*  新建仓库，在弹出的菜单中按仓库类型选择 OSS／Nexus

*   填入相应的仓库用户名／密码（OSS 需要填写云平台的 Access Key／Secret Key）

*   待系统加载仓库成功后，选取需要注册到 repository 或者 bucket

==注意：==

*  如果加载失败，可能是仓库地址 URL 不对，比如 nexus 多了 /nexus 或者 OSS 权限不够
*  如果 Nexus 或者 OSS 下有过多的 repo 或者 bucket，加载需要时间，请耐心等待
*  仓库可以随时删除或修改，但需注意，如果已经有应用版本使用了的仓库，修改和删除可能会引起代码部署下载地址验证失败

## 「代码部署功能」应用注册与管理 

在配置完仓库后，我们需要添加需要部署的应用，以便注册应用版本，具体步骤如下：

* 点击进入代码部署->应用管理界面

*  新建应用，在弹出的菜单中按业务命名具体的应用名称和描述

   *  应用名称在当前用户下全局唯一
   *  应用可以随时修改和删除，但是如果已经有 Jenkins Job 对应注册到该应用下，修改和删除可能会导致 Jenkins Job 失败

## 「代码部署功能」版本注册、部署

创建完仓库及应用，即可以注册应用版本，并触发代码部署了，其中，注册应用版本，有两种途径，第一种，通过 FIT2CLOUD 手动注册版本，第二种，通过 Jenkins 自动注册，当然，第二种方式是我们更推荐的途径。

* 通过 FIT2CLOUD 手动注册版本

  * 应用列表里，点击&quot;版本数量&quot;，进入到添加应用程序版本页面，点击添加应用版本
  *  在弹出的菜单中，选择应用版本所在的具体仓库
  *  依据具体版本信息，填写备注及版本号
  *  点击保存，则手动添加了一条版本信息，后续可以对该条应用版本触发代码部署

* 通过 Jenkins 自动注册版本

 在 Jenkins Job 中，添加 FIT2CLOUD 代码部署操作，填写具体信息如下所示：

**FIT2CLOUD账号设置:**
*   FIT2CLOUD的Consumer Key
*   FIT2CLOUD的Secret Key
*   FIT2CLOUD的API EndPoint

所需的信息可以在FIT2LCOUD控制台用户的API信息中查看。

**注册应用版本配置信息:**

*   仓库名称 : FIT2CLOUD中对应的仓库名称。
*   应用名称 : FIT2CLOUD中对应的应用名称。
*   应用版本名称 : 将会注册到FIT2CLOUD中的应用版本的名称，应用版本名称需要动态变化，以防出现版本名重复的问题。我们推荐的应用版本名为：V${POM_VERSION}-Build_${BUILD_NUMBER}
*   应用版本存放路径 :
*   下载地址中支持使用Jenkins内部变量，如：${BUILD_NUMBER} ${POM_VERSION}等。
*   如果为OSS仓库，不需要填写OSS下载地址的Endpoint部分，例如：http://f2c.oss-cn-hangzhou.aliyuncs.com/ci-demo-app/1.0/ci-demo-app-1.0-13.zip 填写内容为${POM_ARTIFACTID}/${POM_VERSION}/${POM_ARTIFACTID}.zip如果为nexus仓库，下载地址为全路径。例如：http://nexus-host-name/service/local/repositories/releases/content/com/fit2cloud/example/ci-demo-app/1.0/ci-demo-app-1.0-42.zip填写内容为：http://nexus-host-name/service/local/repositories/releases/content/com/fit2cloud/example/${POM_ARTIFACTID}/${POM_VERSION}/${POM_ARTIFACTID}-${POM_VERSƒION}-${BUILD_NUMBER}.zip
*   备注

    * 点击保存， Jenkins 每次 build 之后，就会自动向配置的 FIT2CLOUD 中注册相应的应用版本信息

    *  切换回 FIT2CLOUD， 我们就能看到 Jenkins 自动注册的版本，该版本可以用于后续代码部署

##  触发代码部署 

同样的，触发代码部署动作，可以选择手动点击每个应用版本后面的部署按钮，根据需要，在弹出的对话框中选择需要部署应用的集群，主机组，主机，并且当对于整个主机组或者集群部署时，可以选择需要的策略，比如全部部署、对半部署、还是单台依次部署。

也可以选择 Jenkins 配置应用注册信息时，直接选定自动部署的目标集群，主机组，主机，在勾选了「触发代码部署」后，填写相应的信息如下，每次 Jenkins Job build 时，就会自动注册应用信息，并触发代码部署操作：

触发代码部署配置信息：

*   目标集群名称 : FIT2CLOUD中将要进行部署的集群名称。
*   目标虚机组名称 : FIT2CLOUD中将要进行部署的虚机组名称。
*   目标虚机Id : FIT2CLOUD中将要进行部署的虚机Id。
*   部署策略 : FIT2CLOUD中对应的部署策略。